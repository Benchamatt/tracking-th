<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weiming Tracking</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --surface:#ffffff;
      --surface-2:#f1f4f9;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --shadow: 0 10px 24px rgba(2, 6, 23, 0.08);

      --brand:#0f5fbf;
      --brand-2:#0a3f7a;

      --ok:#0f766e;
      --warn:#b45309;
      --bad:#b91c1c;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
      background: var(--bg);
      color:var(--text);
    }

    .wrap{max-width:980px;margin:auto;padding:20px}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:14px}
    .btn{padding:12px;border-radius:12px;border:none;background:var(--brand);color:#fff;cursor:pointer}
    .timeline{padding-left:18px}
    .event{background:var(--surface-2);padding:10px;border-radius:12px;margin-bottom:10px}
    .time{font-size:12px;color:var(--muted)}
    .text{font-weight:600}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>ค้นหาเลขพัสดุ</h2>
    <input id="no" placeholder="เลขพัสดุ" />
    <button id="btn" class="btn">ค้นหา</button>
  </div>

  <div class="card" id="summary" style="display:none"></div>

  <div class="card" id="history" style="display:none">
    <h3>ไทม์ไลน์สถานะ</h3>
    <div id="timeline" class="timeline"></div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
const summary = $("summary");
const history = $("history");
const timeline = $("timeline");
const btn = $("btn");
const noEl = $("no");

/* ---------- mapping ---------- */
const STATUS_MAP = [
  { zh:"配送中", th:"อยู่ระหว่างจัดส่ง" },
  { zh:"配完", th:"พัสดุถึงผู้รับเรียบร้อยแล้ว" },
  { zh:"公司行號休息", th:"จัดส่งไม่สำเร็จเนื่องจากบริษัทหยุดทำการ" },
  { zh:"轉運中", th:"อยู่ระหว่างการขนส่งไปยังศูนย์ย่อย(สาขาปลายทาง)" },
  { zh:"海關清關", th:"พัสดุอยู่ระหว่างการเดินพิธีการศุลกากร" },
  { zh:"連線收單建檔", th:"ระบบศุลกากรรับและบันทึกข้อมูลเรียบร้อยแล้ว" },
  { zh:"通關方式C1", th:"พิธีการศุลกากรแบบ C1" },
  { zh:"放行", th:"พัสดุผ่านพิธีการศุลกากรเรียบร้อยแล้ว" },
  { zh:"不受理不可補正之錯單", th:"ข้อมูลพิธีการไม่ถูกต้อง โปรดติดต่อเจ้าหน้าที่" },
  { zh:"訂單已接收", th:"ระบบรับคำสั่งเรียบร้อยแล้ว" },
  { zh:"已經打印好地址面單", th:"พิมพ์ใบปะหน้าที่อยู่เรียบร้อยแล้ว" },
  { zh:"已准備從集運倉出倉", th:"พัสดุออกจากคลังแล้ว" },
  { zh:"EZ WAY", th:"โปรดตรวจสอบการลงทะเบียน EZ WAY" }
];

function normalize(s){
  return (s||"").replace(/\s+/g," ").trim();
}

function extractZh(s){
  const m = normalize(s).match(/\(([^)]+)\)/);
  return m ? m[1] : normalize(s);
}

function toThaiStatus(status_th, mixed){
  const zh = extractZh(mixed);

  for (const m of STATUS_MAP){
    if (zh.includes(m.zh)) return m.th;
  }

  if (status_th) return status_th;
  return "กำลังดำเนินการ";
}

/* ---------- render ---------- */
function renderSummary(data){
  const mixed = data.latest_status || data.latest_status_th || "";
  const th = toThaiStatus(data.latest_status_th, mixed);

  summary.style.display="block";
  summary.innerHTML = `
    <b>เลขพัสดุ:</b> ${data.tracking_no}<br>
    <b>สถานะล่าสุด:</b> ${th}
  `;
}

function renderTimeline(events){
  timeline.innerHTML = (events||[]).map(e=>{
    const mixed = e.status || e.status_th || "";
    const th = toThaiStatus(e.status_th, mixed);
    return `
      <div class="event">
        <div class="time">${e.time||"-"}</div>
        <div class="text">${th}</div>
      </div>
    `;
  }).join("");

  history.style.display="block";
}

/* ---------- run ---------- */
async function run(){
  const no = noEl.value.trim();
  if (!no) return alert("กรุณากรอกเลขพัสดุ");

  const r = await fetch(`/api/track?no=${encodeURIComponent(no)}`);
  const data = await r.json();

  renderSummary(data);
  renderTimeline(data.events);
}

btn.addEventListener("click", run);
noEl.addEventListener("keydown", e=>{ if(e.key==="Enter") run(); });
</script>
</body>
</html>
