<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weiming Tracking</title>

<style>
/* === CSS เดิมทั้งหมด คงไว้ === */
:root{
  --bg:#f6f8fb;
  --surface:#ffffff;
  --surface-2:#f1f4f9;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;
  --shadow: 0 10px 24px rgba(2, 6, 23, 0.08);
  --brand:#0f5fbf;
  --brand-2:#0a3f7a;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Tahoma, sans-serif;
  background: var(--bg);
  color:var(--text);
}
.wrap{max-width:980px;margin:0 auto;padding:20px}
.card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  box-shadow: var(--shadow);
  padding: 16px;
}
.grid{
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap:14px;
  margin-top:14px;
}
@media(max-width:860px){.grid{grid-template-columns:1fr}}
input{
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background: var(--surface-2);
}
.btn{
  border:none;
  border-radius:14px;
  padding:12px 14px;
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  color:#fff;
  cursor:pointer;
}
.group{margin-top:12px}
.groupTitle{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-weight:800;
}
 .timeline{
  margin-top:10px;
  padding-left:18px;
  position:relative;

  display:flex;
  flex-direction:column;
  align-items:flex-start;
}
.timeline{margin-top:10px;padding-left:18px;position:relative}
.timeline:before{
  content:"";
  position:absolute;
  left:7px;top:0;bottom:0;
  width:2px;background:#cbd5e1;
}
.event{
  display: inline-block;
  width: fit-content;
  max-width: 100%;
  background:var(--surface-2);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
  margin-bottom:10px;
}
.event .time{font-size:12px;color:var(--muted)}
.event .text{font-weight:700}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <h3>ค้นหาเลขพัสดุ</h3>
  <input id="no" placeholder="เลขพัสดุ" />
  <br/><br/>
  <button class="btn" id="btn">ค้นหา</button>
</div>

<div class="grid">
  <div></div>

  <div>
    <div class="card" id="history" style="display:none">
      <h3>ไทม์ไลน์สถานะ</h3>
      <div id="groups"></div>
    </div>
  </div>
</div>

</div>

<script>
const $ = id => document.getElementById(id);
const btn = $("btn");
const noEl = $("no");
const history = $("history");
const groupsEl = $("groups");

/* ===== Mapping จีน → ไทย (ใช้ timeline เท่านั้น) ===== */
const STATUS_MAP = [
  { zh:"順利送達", th:"พัสดุถึงผู้รับเรียบร้อยแล้ว" },
  { zh:"配送中", th:"อยู่ระหว่างจัดส่ง" },
  { zh:"已集貨", th:"พัสดุอยู่ศูนย์คัดแยกพัสดุ" },
  { zh:"出倉處理", th:"กำลังดำเนินการนำสินค้าออกจากคลัง" },
  { zh:"連線收單建檔", th:"ระบบศุลกากรรับและบันทึกข้อมูลเรียบร้อยแล้ว" },
  { zh:"已經打印好地址面單", th:"พิมพ์ใบปะหน้าที่อยู่เรียบร้อยแล้ว" },
  { zh:"您已下單成功", th:"สร้างออเดอร์การจัดส่งเรียบร้อย" },
];

function matchThai(raw){
  if(!raw) return null;
  const m = STATUS_MAP.find(x => raw.includes(x.zh));
  return m ? m.th : null;
}

function pickStatus(obj){
  return obj.status_zh || obj.status || obj.message || "";
}
function pickTime(obj){
  return obj.time || obj.datetime || "-";
}

function renderTimeline(events){
  const items = events
    .map(e => ({
      time: pickTime(e),
      th: matchThai(pickStatus(e))
    }))
    .filter(x => x.th);

  if(!items.length){
    history.style.display="none";
    return;
  }

  groupsEl.innerHTML = `
    <div class="group">
      <div class="groupTitle">สถานะพัสดุ</div>
      <div class="timeline">
        ${items.map(it=>`
          <div class="event">
            <div class="time">${it.time}</div>
            <div class="text">${it.th}</div>
          </div>
        `).join("")}
      </div>
    </div>
  `;
  history.style.display="block";
}

async function run(){
  const no = noEl.value.trim();
  if(!no){alert("กรุณากรอกเลขพัสดุ");return;}

  try{
    const r = await fetch(`/api/track?no=${encodeURIComponent(no)}`);
    const data = await r.json();
    const events = data.events || [];
    renderTimeline(events);
  }catch(e){
    alert("เกิดข้อผิดพลาด");
  }
}

btn.addEventListener("click", run);
noEl.addEventListener("keydown", e => e.key==="Enter" && run());
</script>
</body>
</html>
