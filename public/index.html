<script>
  const $ = (id) => document.getElementById(id);
  const summary = $("summary");
  const history = $("history");
  const timeline = $("timeline");
  const btn = $("btn");
  $("year").textContent = String(new Date().getFullYear());

  function normalize(s){
    return (s || "").replace(/\s+/g, " ").trim();
  }

  function hasCJK(s){
    return /[\u4E00-\u9FFF]/.test(s || "");
  }

  // ===== เรียงกลุ่มตามที่ต้องการ =====
  const GROUP_ORDER = ["ต้นทาง", "ศุลกากร", "ปลายทาง"];
  const GROUP_RANK = Object.fromEntries(GROUP_ORDER.map((g, i) => [g, i]));

  // ===== MAPPING: อิงตาม “รายการที่คุณให้” เท่านั้น (นอกเหนือ = ไม่แสดง) =====
  const RULES = [
    // --- ปลายทาง ---
    { key: "配完-配完>順利送達>白河營業所", th: "พัสดุถึงผู้รับเรียบร้อยแล้ว", group: "ปลายทาง" },
    { key: "配送中-配送中>白河營業所", th: "อยู่ระหว่างจัดส่ง", group: "ปลายทาง" },
    { key: "公司行號休息-公司行號休息>白河營業所", th: "จัดส่งไม่สำเร็จเนื่องจากบริษัทหยุดทำการ", group: "ปลายทาง" },
    { key: "轉運中-轉運中>已集貸>北三特服二所", th: "อยู่ระหว่างการขนส่งไปยังศูนย์ย่อย(สาขาปลายทาง)", group: "ปลายทาง" },

    // --- ศุลกากร ---
    { key: "貨物在目的地國家海關清關中", th: "พัสดุอยู่ระหว่างการเดินพิธีการศุลกากรในประเทศปลายทาง", group: "ศุลกากร" },
    { key: "連線收單建檔", th: "ระบบศุลกากรรับและบันทึกข้อมูลเรียบร้อยแล้ว", group: "ศุลกากร" },
    { key: "通關方式C1", th: "พิธีการศุลกากรแบบ C1", group: "ศุลกากร" },
    { key: "放行", th: "พัสดุผ่านพิธีการศุลกากรเรียบร้อยแล้ว", group: "ศุลกากร" },
    {
      // ให้ match จาก “ประโยคขึ้นต้น” ตามที่คุณให้ (ไม่ต้องทั้งยาว)
      key: "由於海關系統查無此包裹申報人資料",
      th: "เนื่องจากระบบศุลกากรไม่พบข้อมูลผู้เดินพิธีการ โปรดตรวจสอบว่าผู้รับพัสดุได้ลงทะเบียนกับ EZ WAY แล้วหรือไม่ หากยังไม่ได้ลงทะเบียนโปรดลงทะเบียนให้เรียบร้อย ถ่ายภาพหน้าจอให้ติดชื่อ/หมายเลขโทรศัพท์และหมายเลขบัตรประชาชนของผู้เดินพิธีการ แล้วส่งให้เจ้าหน้าที่ลูกค้าสัมพันธ์ของWeiming หลังจากได้รับข้อมูลแล้ว พัสดุจะได้รับการปล่อยภายในประมาณ 1-2 วันทำการ",
      group: "ศุลกากร"
    },
    { key: "不受理不可補正之錯單", th: "ข้อมูลที่ใช้เดินพิธีการไม่สอดคล้องกัน โปรดติดต่อเจ้าหน้าที่", group: "ศุลกากร" },

    // --- ต้นทาง(คลังสินค้า) ---
    { key: "您的貨物已准備從集運倉出倉", th: "พัสดุุของคุณออกคลัง เพื่อเตรียมส่งไปยังสนามบินแล้ว", group: "ต้นทาง" },
    { key: "已經打印好地址面單", th: "พิมพ์ใบปะหน้าที่อยู่เรียบร้อยแล้ว", group: "ต้นทาง" },
    { key: "您已下單成功!請等待倉庫人員作業出貨", th: "สร้างออเดอร์การจัดส่งเรียบร้อย", group: "ต้นทาง" },
  ];

  // match -> {text, group} / no match -> null
  function mapStatusByChinese(rawCN){
    const t = normalize(rawCN);
    if(!t) return null;

    // ต้องตรง rules เท่านั้น
    let out = null;
    for(const r of RULES){
      if(t.includes(r.key)) out = { text: r.th, group: r.group };
    }
    return out;
  }

  // ✅ เลือก “ข้อความจีนจาก API” โดยไม่ยึด field เดียว
  // แต่ยังคงเงื่อนไขว่า ต้องเป็นจีนเท่านั้น
  function pickChineseFromEvent(e){
    const fields = [e.status, e.latest_status_th, e.status_th];
    for(const f of fields){
      const t = normalize(f);
      if(t && hasCJK(t)) return t;
    }
    return "";
  }

  function setLoading(){
    summary.style.display = "block";
    history.style.display = "none";
    summary.innerHTML = `
      <div class="loading">
        <span class="spinner" aria-hidden="true"></span>
        <div>
          <div style="font-weight:800;color:#0b223c">กำลังค้นหา...</div>
          <div class="small">โปรดรอสักครู่</div>
        </div>
      </div>
    `;
  }

  function setError(msg){
    summary.style.display = "block";
    history.style.display = "none";
    summary.innerHTML = `<div class="errorBox"><b>ไม่สำเร็จ:</b> ${msg || "เกิดข้อผิดพลาด"}</div>`;
  }

  function renderSummary(data, latestTH){
    summary.style.display = "block";
    summary.innerHTML = `
      <div class="muted">เลขพัสดุ</div>
      <div class="headline" style="margin-bottom:8px">${data.tracking_no || "-"}</div>
      <div class="muted">อัปเดตล่าสุด</div>
      <div style="font-weight:800;margin-top:4px;color:#0b223c">${data.last_update || "-"}</div>

      <div style="margin-top:12px" class="muted">สถานะล่าสุด (เฉพาะที่ตรง rules)</div>
      <div class="headline">${latestTH || "-"}</div>
    `;
  }

  // ✅ สร้างรายการ + กันซ้ำ + เรียงกลุ่ม
  function mapAllEvents(rawEvents){
    if(!Array.isArray(rawEvents)) return [];

    const seen = new Set();
    const out = [];

    rawEvents.forEach((e, idx) => {
      const cn = pickChineseFromEvent(e);           // ✅ จีนจาก API
      const mapped = mapStatusByChinese(cn);        // ✅ ตรง rules เท่านั้น
      if(!mapped) return;

      const timeText = normalize(e.time);
      const timeKey  = timeText || `idx:${idx}`;    // กันซ้ำแม้ time ว่าง

      // กันซ้ำแบบเข้ม: กลุ่ม + ข้อความ + เวลา/idx
      const dedupeKey = `${timeKey}||${mapped.group}||${mapped.text}`;
      if(seen.has(dedupeKey)) return;
      seen.add(dedupeKey);

      out.push({ idx, time: timeText || "-", text: mapped.text, group: mapped.group });
    });

    // เรียงกลุ่ม: ต้นทาง → ศุลกากร → ปลายทาง
    // ภายในกลุ่ม: คงลำดับตาม API (idx)
    out.sort((a, b) => {
      const ga = GROUP_RANK[a.group] ?? 999;
      const gb = GROUP_RANK[b.group] ?? 999;
      if(ga !== gb) return ga - gb;
      return a.idx - b.idx;
    });

    return out;
  }

  function renderTimeline(events){
    let html = "";
    for(const g of GROUP_ORDER){
      const items = events.filter(e => e.group === g);
      if(items.length === 0) continue;

      html += `<div class="sectionTitle">${g}</div>`;
      html += items.map(e => `
        <div class="event">
          <div class="time">${e.time}</div>
          <div class="text">${e.text}</div>
        </div>
      `).join("");
    }

    timeline.innerHTML = html || `<div class="muted" style="padding:10px 0">ไม่มีสถานะที่ตรงกับรายการที่กำหนด</div>`;
  }

  async function run(){
    const no = $("no").value.trim();
    if(!no){ alert("กรุณากรอกเลขพัสดุ"); return; }

    btn.disabled = true;
    setLoading();

    try{
      const r = await fetch(`/api/track?no=${encodeURIComponent(no)}`);
      const data = await r.json();

      if(!r.ok){
        setError(data.error || "ไม่พบข้อมูล");
        return;
      }

      // latest: เอาตาม “ลำดับ API” ก่อนจัดกลุ่ม
      let latest = "-";
      if(Array.isArray(data.events)){
        for(const e of data.events){
          const cn = pickChineseFromEvent(e);
          const m = mapStatusByChinese(cn);
          if(m){ latest = m.text; break; }
        }
      }

      const allEvents = mapAllEvents(data.events);

      renderSummary(data, latest);
      renderTimeline(allEvents);
      history.style.display = "block";
    }catch(e){
      setError(String(e));
    }finally{
      btn.disabled = false;
    }
  }

  $("btn").addEventListener("click", run);
  $("no").addEventListener("keydown", (e) => { if(e.key === "Enter") run(); });
</script>
