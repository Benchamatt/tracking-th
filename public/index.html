<!-- คัดลอก <script> ด้านล่างนี้ไปแทน <script> เดิมได้เลย (หรือแทนเฉพาะฟังก์ชันแปลก็ได้) -->
<script>
  const $ = (id) => document.getElementById(id);
  const summary = $("summary");
  const history = $("history");
  const timeline = $("timeline");
  const btn = $("btn");
  $("year").textContent = String(new Date().getFullYear());

  // ----------------- CN -> TH (ตาม mapping ที่คุณให้มา) -----------------
  // หลักการ:
  // 1) ถ้าข้อความมีจีน -> พยายาม match แบบ "มีคำ/แพทเทิร์น" ด้วย priority (จากเฉพาะเจาะจงที่สุดไปหาทั่วไป)
  // 2) ถ้าไม่เจอ -> fallback เป็นข้อความไทยเดิม (ถ้าเป็นไทย) หรือข้อความกลาง ๆ
  function toThaiStatus(raw){
    const t = (raw || "").trim();
    if(!t) return "-";

    const hasCJK = /[\u4E00-\u9FFF]/.test(t);

    // ---------- 0) ถ้าไม่ใช่ภาษาจีน ให้คืนค่าเดิม ----------
    if(!hasCJK) return t;

    // ---------- 1) Priority rules (เฉพาะเจาะจงก่อน) ----------
    // NOTE: ใช้ .includes() เป็นหลัก เพราะข้อความจริงมักยาวและมี ">" "-" "," ปน
    const rules = [
      // ตัวอย่างข้อความยาวเรื่อง EZ WAY (ต้องมาก่อนคำว่า 海關 / 查無 ฯลฯ)
      {
        test: (s) => s.includes("由於海關系統查無此包裹申報人資料") || (s.includes("EZ WAY") && s.includes("海關") && s.includes("查無")),
        th: "ระบบศุลกากรไม่พบข้อมูลผู้ยื่นสำแดง กรุณาลงทะเบียน EZ WAY"
      },

      // ประโยคเฉพาะอื่น ๆ
      { test: (s) => s.includes("不受理不可補正之錯單"), th: "ข้อมูลออเดอร์ไม่ถูกต้อง ระบบไม่สามารถดำเนินการได้" },
      { test: (s) => s.includes("貨物在目的地國家海關清關中"), th: "สินค้ากำลังผ่านพิธีการศุลกากรในประเทศปลายทาง" },

      // กลุ่มจัดส่ง / นำส่ง
      { test: (s) => s.includes("包裹已經送達收件人"), th: "จัดส่งสำเร็จ" },
      { test: (s) => s.includes("順利送達") || s.includes("配完"), th: "พัสดุถึงผู้รับเรียบร้อยแล้ว" },

      // SD กำลังนำส่ง (ให้ตรงตามที่แปะมา)
      { test: (s) => s.includes("SD正在將包裹配送到收件人途中"), th: "พนักงานกำลังนำพัสดุไปส่งให้ผู้รับ" },

      // พัก/หยุดทำการ
      { test: (s) => s.includes("暫置營業所") || s.includes("暫置保管"), th: "พัสดุถูกพักไว้ชั่วคราวที่สาขา" },
      { test: (s) => s.includes("公司行號休息"), th: "สาขาปลายทางหยุดทำการ" },

      // ระหว่างการขนส่ง / รวบรวม / คลัง
      { test: (s) => s.includes("轉運中"), th: "อยู่ระหว่างการขนส่งไปยังศูนย์กระจายสินค้า" },
      { test: (s) => s.includes("SD已經至寄件人指定地點收到包裹") || s.includes("已集貨"), th: "รวบรวมสินค้าเรียบร้อย" },

      // คลัง/ออกจากคลัง/เตรียมออก
      { test: (s) => s.includes("出倉處理"), th: "กำลังดำเนินการนำสินค้าออกจากคลัง" },
      { test: (s) => s.includes("您的貨物已准備從集運倉出倉"), th: "สินค้าของคุณเตรียมออกจากคลังรวมสินค้า" },

      // น้ำหนัก/พิมพ์ใบปะหน้า/หยิบสินค้า
      { test: (s) => s.includes("貨物已經完成重量二次審核"), th: "ตรวจสอบน้ำหนักสินค้าเรียบร้อย" },
      { test: (s) => s.includes("已經打印好地址面單"), th: "พิมพ์ใบปะหน้าที่อยู่เรียบร้อยแล้ว" },
      { test: (s) => s.includes("倉庫同事已揀貸,等待打印地址面單"), th: "แพ็กสินค้าเรียบร้อย กำลังเตรียมจัดส่ง" },

      // ออเดอร์
      { test: (s) => s.includes("連線收單建檔"), th: "ระบบรับออเดอร์และบันทึกข้อมูลเรียบร้อยแล้ว" },
      { test: (s) => s.includes("訂單已接收"), th: "ระบบรับคำสั่งซื้อเรียบร้อยแล้ว" },
      { test: (s) => s.includes("您已下單成功"), th: "พัสดุผู้ส่งได้รับแล้ว  รอการดำเนินการจากคลังสินค้า" },

      // ศุลกากร C1 / ปล่อยของ
      { test: (s) => s.includes("通關方式C1"), th: "พิธีการศุลกากรแบบ C1" },
      { test: (s) => s.includes("放行"), th: "ผ่านพิธีการศุลกากรแล้ว" },

      // สถานะ配送中 (ปล่อยท้าย เพื่อไม่ไปทับ SD…)
      // หมายเหตุ: คุณให้หลายคำแปลสำหรับ "配送中" ที่ต่างกันตามบริบท
      // ที่นี่จะเลือกแบบ "อยู่ระหว่างการจัดส่ง" เป็นค่าเริ่มต้น
      { test: (s) => s.includes("配送中"), th: "อยู่ระหว่างการจัดส่ง" },
    ];

    for(const r of rules){
      if(r.test(t)) return r.th;
    }

    // ---------- 2) Fallback (เป็นจีนแต่ไม่รู้จัก) ----------
    return "อยู่ระหว่างดำเนินการ (รออัปเดตสถานะจากระบบ)";
  }

  // Badge classification
  function classify(th){
    if (th === "จัดส่งสำเร็จ" || th === "พัสดุถึงผู้รับเรียบร้อยแล้ว") return { cls:"ok", label:"จัดส่งสำเร็จ" };
    if (th.includes("ไม่พบข้อมูล") || th.includes("ไม่สามารถ") || th.includes("ผิด") || th.includes("ศุลกากรไม่พบข้อมูล")) return { cls:"bad", label:"มีปัญหา" };
    return { cls:"warn", label:"กำลังดำเนินการ" };
  }

  // Use latest event as truth (topmost event is newest)
  function getLatestThaiFromEvents(events){
    if(!Array.isArray(events) || events.length === 0) return "-";
    return toThaiStatus(events[0]?.status_th || "");
  }

  function renderSummary(data){
    const events = Array.isArray(data?.events) ? data.events : [];
    const latestTH = getLatestThaiFromEvents(events) || toThaiStatus(data?.latest_status_th || "");
    const cls = classify(latestTH);

    summary.style.display = "block";
    summary.innerHTML = `
      <div class="summaryTop">
        <div class="kv">
          <div><b>เลขพัสดุ</b> <span class="value">${data.tracking_no || "-"}</span></div>
          <div><b>อัปเดตล่าสุด</b> <span class="value">${data.last_update || "-"}</span></div>
        </div>
        <span class="badge ${cls.cls}">
          <span class="dot"></span>
          ${cls.label}
        </span>
      </div>

      <div class="muted">สถานะล่าสุด</div>
      <div class="headline">${latestTH || "-"}</div>
    `;
  }

  // ✅ SHOW ALL events (no limit, no dedupe)
  function mapAllEvents(rawEvents){
    if(!Array.isArray(rawEvents)) return [];
    return rawEvents.map(e => ({
      ...e,
      _th: toThaiStatus(e.status_th || ""),
    }));
  }

  function renderTimeline(events){
    const items = (events || []).map((e, idx) => `
      <div class="event ${idx === 0 ? "isLatest" : ""}">
        <div class="time">${e.time || "-"}</div>
        <div class="text">${e._th || "-"}</div>
      </div>
    `).join("");

    timeline.innerHTML = items || `<div class="muted" style="padding:10px 0">ไม่มีข้อมูล</div>`;
  }

  function setLoading(){
    summary.style.display = "block";
    history.style.display = "none";
    summary.innerHTML = `
      <div class="loading">
        <span class="spinner" aria-hidden="true"></span>
        <div>
          <div style="font-weight:800;color:#0b223c">กำลังค้นหา...</div>
          <div class="small">โปรดรอสักครู่</div>
        </div>
      </div>
    `;
  }

  function setError(msg){
    summary.style.display = "block";
    history.style.display = "none";
    summary.innerHTML = `<div class="errorBox"><b>ไม่สำเร็จ:</b> ${msg || "เกิดข้อผิดพลาด"}</div>`;
  }

  async function run(){
    const no = $("no").value.trim();
    if(!no){ alert("กรุณากรอกเลขพัสดุ"); return; }

    btn.disabled = true;
    setLoading();

    try{
      const r = await fetch(`/api/track?no=${encodeURIComponent(no)}`);
      const data = await r.json();

      if(!r.ok){
        setError(data.error || "ไม่พบข้อมูล");
        return;
      }

      renderSummary(data);

      const allEvents = mapAllEvents(data.events);
      renderTimeline(allEvents);

      history.style.display = "block";
    }catch(e){
      setError(String(e));
    }finally{
      btn.disabled = false;
    }
  }

  $("btn").addEventListener("click", run);
  $("no").addEventListener("keydown", (e) => { if(e.key === "Enter") run(); });
</script>
