<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weiming Tracking</title>

<!-- ===================== STYLE ===================== -->
<style>
/* === Theme === */
:root{
  --bg:#f6f8fb;--surface:#fff;--surface-2:#f1f4f9;
  --text:#0f172a;--muted:#64748b;--border:#e5e7eb;
  --brand:#0f5fbf;--brand-2:#0a3f7a;
  --ok:#0f766e;--warn:#b45309;--bad:#b91c1c;
  --shadow:0 10px 24px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
  background:var(--bg);color:var(--text)
}
.wrap{max-width:980px;margin:auto;padding:20px}

/* === Cards === */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:16px;
}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
@media(max-width:860px){.grid{grid-template-columns:1fr}}

input{
  width:100%;padding:12px 14px;border-radius:14px;
  border:1px solid var(--border);background:var(--surface-2)
}
.btn{
  border:none;border-radius:14px;padding:12px 14px;
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  color:#fff;cursor:pointer
}
.btn:disabled{opacity:.6}

/* === Summary === */
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700
}
.badge.ok{background:rgba(15,118,110,.12);color:var(--ok)}
.badge.warn{background:rgba(180,83,9,.12);color:var(--warn)}
.badge.bad{background:rgba(185,28,28,.12);color:var(--bad)}

/* === Stepper === */
.steps{display:flex;gap:10px;margin-top:12px}
.step{flex:1;padding:10px;border-radius:14px;background:var(--surface-2)}
.step.active{background:rgba(15,95,191,.08)}
.step.done{opacity:.8}

/* === Timeline === */
.group{margin-top:12px}
.groupTitle{font-weight:800;font-size:13px;margin-bottom:6px}
.timeline{padding-left:18px;position:relative}
.timeline:before{
  content:"";position:absolute;left:7px;top:0;bottom:0;
  width:2px;background:#cbd5e1
}
.event{
  background:var(--surface-2);
  border:1px solid var(--border);
  border-radius:14px;padding:10px 12px;margin-bottom:10px
}
.event .time{font-size:12px;color:var(--muted)}
.event .text{font-weight:700}

/* === Loading / Error === */
.error{color:var(--bad);font-size:13px}
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h3>ค้นหาเลขพัสดุ</h3>
    <input id="no" placeholder="เลขพัสดุ" />
    <br/><br/>
    <button class="btn" id="btn">ค้นหา</button>
  </div>

  <div class="grid">
    <div>
      <div class="card" id="summary" style="display:none"></div>
    </div>
    <div>
      <div class="card" id="history" style="display:none">
        <h3>ไทม์ไลน์สถานะ</h3>
        <div id="groups"></div>
      </div>
    </div>
  </div>

</div>

<!-- ===================== SCRIPT ===================== -->
<script>
const $=id=>document.getElementById(id);
const btn=$("btn"),noEl=$("no"),summary=$("summary"),history=$("history"),groupsEl=$("groups");

/* ===== Status Map ===== */
const STATUS_MAP=[
  {zh:"順利送達",th:"พัสดุถึงผู้รับเรียบร้อยแล้ว",g:"last"},
  {zh:"配送中",th:"อยู่ระหว่างจัดส่ง",g:"last"},
  {zh:"已集貨",th:"พัสดุอยู่ศูนย์คัดแยกพัสดุ",g:"last"},
  {zh:"出倉處理",th:"กำลังนำสินค้าออกจากคลัง",g:"custom"},
  {zh:"連線收單建檔",th:"ศุลกากรรับข้อมูลแล้ว",g:"custom"},
  {zh:"已經打印好地址面單",th:"พิมพ์ใบปะหน้าที่อยู่แล้ว",g:"origin"},
  {zh:"您已下單成功",th:"สร้างออเดอร์เรียบร้อย",g:"origin"},
];

/* ===== Utils ===== */
const norm=s=>String(s||"").replace(/[!！]/g,"").trim();
const pick=(o)=>o?.status_zh||o?.status||o?.message||"";
const pickTime=o=>o?.time||o?.datetime||"-";

function match(raw){
  raw=norm(raw);
  return STATUS_MAP.find(x=>raw.includes(x.zh))||null;
}

/* ===== Render ===== */
function renderSummary(th){
  if(!th){summary.style.display="none";return}
  const badge=th.includes("ถึงผู้รับ")?"ok":th.includes("ศุล")?"warn":"warn";
  summary.style.display="block";
  summary.innerHTML=`
    <div class="badge ${badge}">${badge==="ok"?"ถึงแล้ว":"กำลังดำเนินการ"}</div>
    <div style="margin-top:6px;font-size:18px;font-weight:800">${th}</div>
  `;
}

function renderTimeline(events){
  const items=events.map(e=>{
    const m=match(pick(e));
    return m?{time:pickTime(e),th:m.th,g:m.g}:null;
  }).filter(Boolean);

  if(!items.length){history.style.display="none";return}

  const groups={origin:[],custom:[],last:[]};
  items.forEach(i=>groups[i.g].push(i));

  groupsEl.innerHTML=Object.entries(groups)
    .filter(([_,v])=>v.length)
    .map(([k,v])=>`
      <div class="group">
        <div class="groupTitle">${k==="origin"?"คลังต้นทาง":k==="custom"?"ศุลกากร":"ปลายทาง"}</div>
        <div class="timeline">
          ${v.map(i=>`
            <div class="event">
              <div class="time">${i.time}</div>
              <div class="text">${i.th}</div>
            </div>
          `).join("")}
        </div>
      </div>
    `).join("");

  history.style.display="block";
}

/* ===== Run ===== */
async function run(){
  const no=noEl.value.trim();
  if(!no){alert("กรุณากรอกเลขพัสดุ");return}
  btn.disabled=true;
  summary.style.display="block";
  summary.innerHTML="กำลังค้นหา...";

  try{
    const r=await fetch(`/api/track?no=${encodeURIComponent(no)}`);
    const data=await r.json();
    const events=data.events||[];
    const latest=match(pick(events[0]||data));
    renderSummary(latest?.th);
    renderTimeline(events);
  }catch(e){
    summary.innerHTML=`<div class="error">เกิดข้อผิดพลาด</div>`;
  }finally{
    btn.disabled=false;
  }
}

btn.onclick=run;
noEl.onkeydown=e=>e.key==="Enter"&&run();
</script>
</body>
</html>
