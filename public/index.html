<script>
  const $ = (id) => document.getElementById(id);
  const summary = $("summary");
  const history = $("history");
  const timeline = $("timeline");
  const btn = $("btn");

  $("year").textContent = String(new Date().getFullYear());

  // 1) Mapping จีน -> ไทย (ตามที่คุณให้มา)
  const STATUS_MAP = [
    { zh: "配完-配完>順利送達>白河營業所", th: "พัสดุถึงผู้รับเรียบร้อยแล้ว" },
    { zh: "配送中-配送中>白河營業所", th: "อยู่ระหว่างจัดส่ง" },
    { zh: "公司行號休息-公司行號休息>白河營業所", th: "จัดส่งไม่สำเร็จเนื่องจากบริษัทหยุดทำการ" },
    { zh: "轉運中-轉運中>已集貸>北三特服二所", th: "อยู่ระหว่างการขนส่งไปยังศูนย์ย่อย(สาขาปลายทาง)" },
    { zh: "貨物在目的地國家海關清關中", th: "พัสดุอยู่ระหว่างการเดินพิธีการศุลกากรในประเทศปลายทาง" },
    { zh: "連線收單建檔", th: "ระบบศุลกากรรับและบันทึกข้อมูลเรียบร้อยแล้ว" },
    { zh: "通關方式C1", th: "พิธีการศุลกากรแบบ C1" },
    { zh: "放行", th: "พัสดุผ่านพิธีการศุลกากรเรียบร้อยแล้ว" },
    {
      zh: "由於海關系統查無此包裹申報人資料，請確認申報人是否已註冊過EZ WAY。 若尚未註冊，請於完成註冊後，至個人資料維護介面截圖申報人名、電話號碼及身分證號，並提交給威名客服，海關受理資料後約1~2個工作天放行",
      th: "เนื่องจากระบบศุลกากรไม่พบข้อมูลผู้เดินพิธีการ โปรดตรวจสอบว่าผู้รับพัสดุได้ลงทะเบียนกับ EZ WAY แล้วหรือไม่ หากยังไม่ได้ลงทะเบียนโปรดลงทะเบียนให้เรียบร้อย ถ่ายภาพหน้าจอให้ติดชื่อ/หมายเลขโทรศัพท์และหมายเลขบัตรประชาชนของผู้เดินพิธีการ แล้วส่งให้เจ้าหน้าที่ลูกค้าสัมพันธ์ของWeiming หลังจากได้รับข้อมูลแล้ว พัสดุจะได้รับการปล่อยภายในประมาณ 1-2 วันทำการ"
    },
    { zh: "不受理不可補正之錯單", th: "ข้อมูลที่ใช้เดินพิธีการไม่สอดคล้องกัน โปรดติดต่อเจ้าหน้าที่" },
    { zh: "您的貨物已准備從集運倉出倉", th: "พัสดุของคุณออกคลัง เพื่อเตรียมส่งไปยังสนามบินแล้ว" },
    { zh: "已經打印好地址面單", th: "พิมพ์ใบปะหน้าที่อยู่เรียบร้อยแล้ว" },
    { zh: "您已下單成功!請等待倉庫人員作業出貨", th: "สร้างออเดอร์การจัดส่งเรียบร้อย" },
  ];

  // 2) แปลงสถานะให้เป็นไทย: ถ้ามีไทยอยู่แล้วใช้ไทย, ถ้าเป็นจีนให้ map, ไม่ตรงก็คืนค่าต้นฉบับ
  function toThaiStatus(status_th, status_zh) {
    const th = (status_th || "").trim();
    if (th) return th;

    const zh = (status_zh || "").trim();
    if (!zh) return "-";

    const exact = STATUS_MAP.find(x => x.zh === zh);
    if (exact) return exact.th;

    // fallback เผื่อสถานะจีนมีข้อความต่อท้าย/ขึ้นต้น
    const loose = STATUS_MAP.find(x => zh.includes(x.zh));
    return loose ? loose.th : zh;
  }

  // Badge classification by Thai status
  function classify(th){
    const s = (th || "").toLowerCase();

    if (s.includes("ถึงแล้ว") || s.includes("จัดส่งสำเร็จ") || s.includes("เซ็นรับ") || s.includes("รับพัสดุ") || s.includes("ถึงผู้รับ")) {
      return { cls:"ok", label:"ถึงแล้ว" };
    }
    if (s.includes("ตีกลับ") || s.includes("ไม่สำเร็จ") || s.includes("ผิดพลาด") || s.includes("ยกเลิก") || s.includes("ปัญหา")) {
      return { cls:"bad", label:"มีปัญหา" };
    }
    if (s.includes("กำลัง") || s.includes("ระหว่าง") || s.includes("ขนส่ง") || s.includes("ส่งต่อ") || s.includes("ออกจาก") || s.includes("กำลังดำเนินการ")) {
      return { cls:"warn", label:"กำลังขนส่ง" };
    }
    return { cls:"warn", label:"กำลังดำเนินการ" };
  }

  function renderSummary(data){
    // รองรับได้หลายชื่อ field เผื่อ API ของคุณส่งไม่เหมือนกัน
    const latestZh = data.latest_status_zh || data.latest_status || data.latest_status_cn || "";
    const latestTh = toThaiStatus(data.latest_status_th, latestZh);

    const cls = classify(latestTh);

    summary.style.display = "block";
    summary.innerHTML = `
      <div class="summaryTop">
        <div class="kv">
          <div><b>เลขพัสดุ</b> <span class="value">${data.tracking_no || data.no || "-"}</span></div>
          <div><b>อัปเดตล่าสุด</b> <span class="value">${data.last_update || data.updated_at || "-"}</span></div>
        </div>

        <span class="badge ${cls.cls}">
          <span class="dot"></span>
          ${cls.label}
        </span>
      </div>

      <div style="display:flex;flex-direction:column;gap:6px">
        <div class="muted">สถานะล่าสุด</div>
        <div style="font-size:18px;font-weight:700;letter-spacing:.2px">
          ${latestTh || "-"}
        </div>
      </div>
    `;
  }

  function renderTimeline(events){
    const items = (events || []).map(e => {
      const zh = e.status_zh || e.status || e.status_cn || "";
      const th = toThaiStatus(e.status_th, zh);

      return `
        <div class="event">
          <div class="time">${e.time || e.datetime || "-"}</div>
          <div class="text">${th}</div>
        </div>
      `;
    }).join("");

    timeline.innerHTML = items || `<div class="muted" style="padding:10px 0">ไม่มีข้อมูล</div>`;
  }

  function setLoading(){
    summary.style.display = "block";
    history.style.display = "none";
    summary.innerHTML = `
      <div class="loading">
        <span class="spinner" aria-hidden="true"></span>
        <div>
          <div style="font-weight:600">กำลังค้นหา...</div>
          <div class="small">โปรดรอสักครู่</div>
        </div>
      </div>
    `;
  }

  function setError(msg){
    summary.style.display = "block";
    history.style.display = "none";
    summary.innerHTML = `<div class="errorBox"><b>ไม่สำเร็จ:</b> ${msg || "เกิดข้อผิดพลาด"}</div>`;
  }

  async function run(){
    const no = $("no").value.trim();
    if(!no){ alert("กรุณากรอกเลขพัสดุ"); return; }

    btn.disabled = true;
    setLoading();

    try{
      const r = await fetch(`/api/track?no=${encodeURIComponent(no)}`);
      const data = await r.json();

      if(!r.ok){
        setError(data.error || "ไม่พบข้อมูล");
        return;
      }

      renderSummary(data);
      renderTimeline(data.events);
      history.style.display = "block";
    }catch(e){
      setError(String(e));
    }finally{
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", run);
  $("no").addEventListener("keydown", (e) => { if(e.key === "Enter") run(); });
</script>
